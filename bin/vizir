#!/usr/bin/env ruby -w

$:.unshift File.join(File.dirname(__FILE__), "..", "lib")

require 'json'
require 'net/ssh/gateway'
require 'optparse'
require 'rest_client'
require 'ruby-growl'
require 'vizir'

ALERT_TIME = 600
REFRESH_TIME = 600
IGNORE_SITES = ['grenoble-exp', 'grenoble-ext', 'grenoble-obs', 'luxembourg', 'portoalegre']

def usage
  puts 'usage: vizir [ -h | --help ] [ -l | --login login_name ] [ -p | --password mygrowlpassword ]'
  exit 1
end

def get(api, uri)
  begin
    return JSON.parse(api[uri + '?structure=simple'].get(:accept => 'application/json'))
  rescue => e
    if e.respond_to?('http_code')
      puts "Error: #{e.http_code}:\n #{e.response.body}"
      return nil
    else
      puts e.inspect
      exit 1
    end
  end
end

def setup_ssh_tunnel
  gateway = Net::SSH::Gateway.new('access.grenoble.grid5000.fr', $login)
  port = gateway.open('api.grenoble.grid5000.fr', 443)
  return gateway, port
end

def apiuri(port)
  return "https://localhost:#{port}/oargridapi"
end

def notify_via_growl(jobid, site_name, time, time_unit)
  g = Growl.new("localhost", "Vizir", ["Job ending soon"], nil, $password)
  g.notify("Job ending soon", "OAR job terminating soon", "Job #{jobid} in #{site_name} ending in #{time} #{time_unit}.")
end

def get_remaining_time(time)
  return (time - Time.now).round
end

$login = nil
$password = nil
opts = OptionParser.new
opts.on('-h', '--help') { usage }
opts.on('-l', '--login STRING', String) { |str| $login = str }
opts.on('-p', '--password STRING', String) { |str| $password = str }
opts.parse(ARGV)

if $login == nil or $password == nil
  usage
end

gateway, port = setup_ssh_tunnel
api = RestClient::Resource.new(apiuri(port))

def learn_new_jobs(api)
  $sites.each do |site|
    site_name = site['site']
    unless IGNORE_SITES.include?(site_name)
      jobs = get(api, "#{site['uri']}/jobs")
      break if jobs == nil
      jobs.each do |job|
        if job['owner'] == $login
          job_details = get(api, "#{job['uri']}")
          break if job_details == nil
          if job_details['jobType'] == 'INTERACTIVE'
            jobid = job_details['Job_Id']

            # If we don't yet know the job, record it in $jobs
            if $jobs[jobid].nil?
              $jobs[jobid] = Vizir::Job.new(jobid, Time.at(Integer(job_details['startTime']) + Integer(job_details['walltime'])), site_name.capitalize)
            end
          end
        end
      end
    end
  end
end  

$jobs = Hash.new
$sites = get(api, '/sites')
exit 1 if $sites == nil

while true
  learn_new_jobs(api)
  $jobs.each do |jobid, job|
    remaining_sec = get_remaining_time(job.end_time)
    if remaining_sec < ALERT_TIME
      remaining_time, remaining_time_unit = Vizir.humanize_time(remaining_sec)
      notify_via_growl(jobid, job.site_name, remaining_time, remaining_time_unit)
    end
  end
  sleep REFRESH_TIME
end

gateway.shutdown!
